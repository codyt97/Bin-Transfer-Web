<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IMEI Bin Move Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0c10; --card:#121318; --ink:#eaf0f7; --muted:#9aa3b2; --accent:#58a6ff; --bad:#f05252; --ok:#10b981; }
    html,body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--ink); }
    .wrap { max-width: 1000px; margin: 40px auto; padding: 0 16px; }
    .card { background: var(--card); border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.35); padding: 20px; }
    h1 { font-size: 20px; margin: 0 0 12px; display:flex; gap:10px; align-items:center; }
    .muted { color: var(--muted); font-size: 12px; }
    .row { display:flex; gap:12px; flex-wrap: wrap; margin: 12px 0; }
    .input { flex:1 1 220px; display:flex; flex-direction:column; gap:6px; }
    .input input { background:#0c0d12; color:var(--ink); border:1px solid #232532; border-radius:10px; padding:12px; font-size:14px; outline:none; }
    .input input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(88,166,255,.15); }
    button { background: var(--accent); color:#031122; border:0; padding:12px 14px; border-radius:12px; font-weight:600; cursor:pointer; }
    button.secondary { background: #1f2432; color:var(--ink); border:1px solid #2c3142; }
    button.danger { background: var(--bad); color: #140a0a; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    thead th { text-align:left; font-size:12px; color:var(--muted); border-bottom:1px solid #232532; padding:8px 6px; }
    tbody td { border-bottom:1px dashed #1e2230; padding:10px 6px; font-size:14px; }
    .right { text-align:right; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#1c2230; border:1px solid #2c3142; }
    .grid { display:grid; grid-template-columns: 1fr auto; align-items: center; gap:10px; }
    .toast { margin-top:10px; font-size:13px; }
    .ok { color: var(--ok); }
    .err { color: var(--bad); }
    .hint { font-size:12px; color: var(--muted); margin-top:6px; }
    code.small { font-size: 12px; background:#0c0d12; padding:2px 6px; border-radius:6px; border:1px solid #232532; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>IMEI Bin Move Builder <span class="pill">-1 from original, +1 to target bin</span></h1>
      <div class="muted">Connects to your Google Sheet inventory (published CSV), then builds 2-row transactions per IMEI.</div>

      <div class="row" style="margin-top:16px">
        <div class="input">
          <label>Google Sheet CSV URL</label>
          <input id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?output=csv" />
          <div class="hint">File → Share → <b>Publish to web</b> → <b>Comma-separated values (.csv)</b>. Paste the link here once.</div>
        </div>
        <div class="input" style="flex:0 0 auto; align-self:flex-end;">
          <button id="btnLoad">Load Inventory</button>
        </div>
      </div>

      <div class="row">
        <div class="input">
          <label>Destination Bin</label>
          <input id="destBin" placeholder="e.g., C-05-03" />
        </div>
        <div class="input">
          <label>IMEI (Lot/Serial)</label>
          <input id="imei" placeholder="Scan or type IMEI" />
        </div>
        <div class="input" style="flex:0 0 auto; align-self:flex-end;">
          <button id="btnAdd" disabled>Add Move</button>
        </div>
      </div>

      <div class="grid">
        <div class="muted">Rows below mirror OrderTime’s expectation: each IMEI yields two entries (Qty = -1 from source bin, +1 to destination).</div>
        <div style="display:flex; gap:8px;">
          <button id="btnClear" class="secondary">Clear</button>
          <button id="btnDownload" class="secondary" disabled>Download CSV</button>
        </div>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th>Item</th>
            <th>Lot/Serial</th>
            <th>Expiration Date</th>
            <th class="right">Qty</th>
            <th class="right">Cost</th>
            <th>Bin</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="toast" class="toast"></div>
    </div>

    <div class="hint" style="margin-top:12px;">
      Tip: Headers in your inventory CSV can be any case. Expected fields per row: 
      <code class="small">Item</code>, <code class="small">Lot/Serial</code>, <code class="small">Expiration Date</code>, <code class="small">Cost</code>, <code class="small">Bin</code>. 
      You can add more, they’ll be ignored.
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    // If you prefer to hardcode, set this and leave the UI blank.
    const INVENTORY_CSV_URL = ""; // e.g., "https://docs.google.com/spreadsheets/d/e/.../pub?output=csv"

    // ====== STATE ======
    let inventory = new Map();   // key: lot/serial (normalized), value: item record
    let moves = [];              // array of rows to render/export
    const toast = (msg, type="") => {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.className = `toast ${type}`;
    };

    // ====== UTIL ======
    const clean = v => String(v ?? "").trim();
    const normKey = v => clean(v).replace(/\s+/g,'').toUpperCase();
    const parseCSV = (text) => {
      const lines = text.split(/\r?\n/).filter(l => l.trim().length);
      if (!lines.length) return [];
      const headers = lines[0].split(",").map(h => h.trim());
      const rows = [];
      for (let i=1; i<lines.length; i++) {
        const cols = splitCsvLine(lines[i], headers.length);
        const obj = {};
        headers.forEach((h, idx) => obj[h] = cols[idx] ?? "");
        rows.push(obj);
      }
      return { headers, rows };
    };

    // Handles quoted fields & commas inside quotes
    function splitCsvLine(line, expectedCols) {
      const out = [];
      let cur = "";
      let inQ = false;
      for (let i=0; i<line.length; i++) {
        const ch = line[i];
        if (ch === '"' ) {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (ch === ',' && !inQ) {
          out.push(cur); cur = "";
        } else cur += ch;
      }
      out.push(cur);
      while (expectedCols && out.length < expectedCols) out.push("");
      return out.map(s => s.trim());
    }

    // Flexible header resolution
    const alias = (obj, name) => {
      const want = name.toLowerCase();
      for (const k of Object.keys(obj)) {
        if (k.toLowerCase() === want) return obj[k];
      }
      // tolerate variations
      const map = {
        "lot/serial": ["lotserial","lot / serial","serial","imei","lot","lot number"],
        "expiration date": ["expiration","exp","expiry","expire date"],
      };
      if (map[name?.toLowerCase()]) {
        for (const v of map[name.toLowerCase()]) {
          for (const k of Object.keys(obj)) {
            if (k.toLowerCase() === v) return obj[k];
          }
        }
      }
      return "";
    };

    // ====== INVENTORY LOAD ======
    async function loadInventory() {
      const urlInput = document.getElementById("csvUrl");
      const url = clean(urlInput.value || INVENTORY_CSV_URL);
      if (!url) { toast("Paste your published CSV URL first.", "err"); return; }
      toast("Loading inventory…");
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const parsed = parseCSV(text);
        inventory.clear();

        parsed.rows.forEach(row => {
          const rec = {
            item: clean(alias(row, "Item")),
            lotSerial: clean(alias(row, "Lot/Serial")),
            exp: clean(alias(row, "Expiration Date")),
            cost: clean(alias(row, "Cost")),
            bin: clean(alias(row, "Bin"))
          };
          if (!rec.lotSerial) return; // skip blanks
          inventory.set(normKey(rec.lotSerial), rec);
        });

        document.getElementById("btnAdd").disabled = false;
        document.getElementById("btnDownload").disabled = moves.length === 0;
        toast(`Inventory loaded: ${inventory.size} serials.`, "ok");
      } catch (e) {
        toast(`Failed to load CSV: ${e.message}`, "err");
      }
    }

    // ====== TRANSACTION BUILDER ======
    function addMove() {
      const destBin = clean(document.getElementById("destBin").value);
      const imei = clean(document.getElementById("imei").value);
      if (!imei) { toast("Enter an IMEI/Lot first.", "err"); return; }
      if (!destBin) { toast("Enter a destination Bin.", "err"); return; }

      const key = normKey(imei);
      const rec = inventory.get(key);
      if (!rec) { toast(`IMEI '${imei}' not found in inventory.`, "err"); return; }

      // Build the two rows: -1 from source, +1 to destination
      const base = {
        item: rec.item || "",
        lotSerial: rec.lotSerial || imei,
        exp: rec.exp || "",
        cost: numOrBlank(rec.cost),
      };

      const fromRow = { ...base, qty: -1, bin: rec.bin || "UNKNOWN" };
      const toRow   = { ...base, qty:  1, bin: destBin };

      // keep as a pair (helps delete both together)
      moves.push({ pairId: crypto.randomUUID(), rows: [fromRow, toRow] });
      render();
      toast(`Added move for ${imei}: ${fromRow.bin} → ${destBin}`, "ok");
      document.getElementById("imei").value = "";
      document.getElementById("imei").focus();
      document.getElementById("btnDownload").disabled = false;
    }

    function numOrBlank(v) {
      const n = Number(String(v).replace(/[^0-9.\-]/g,""));
      return Number.isFinite(n) ? n : "";
    }

    function removePair(pairId) {
      moves = moves.filter(p => p.pairId !== pairId);
      render();
      if (!moves.length) document.getElementById("btnDownload").disabled = true;
    }

    function clearAll() {
      moves = [];
      render();
      document.getElementById("btnDownload").disabled = true;
      toast("Cleared.", "ok");
    }

    function render() {
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";
      for (const pair of moves) {
        for (const row of pair.rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${esc(row.item)}</td>
            <td>${esc(row.lotSerial)}</td>
            <td>${esc(row.exp)}</td>
            <td class="right">${row.qty}</td>
            <td class="right">${row.cost !== "" ? row.cost : ""}</td>
            <td>${esc(row.bin)}</td>
            <td><button class="danger" onclick="removePair('${pair.pairId}')">Remove</button></td>
          `;
          tbody.appendChild(tr);
        }
      }
    }

    const esc = s => String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

    // ====== EXPORT (OrderTime-ish CSV) ======
    // Exports with headers common to your sample. You can add No./Tran Type later if needed.
    function downloadCSV() {
      // Flatten rows with line numbering per pair
      const rows = [];
      for (const pair of moves) {
        const [fromRow, toRow] = pair.rows;
        rows.push({ line: 1, ...fromRow });
        rows.push({ line: 2, ...toRow });
      }

      const headers = ["No.","Tran Type","Line No","Item","Lot/Serial","Expiration Date","Qty","Cost","Bin"];
      const toCsv = (arr) => {
        const lines = [];
        lines.push(headers.join(","));
        for (const r of arr) {
          // No. blank, Tran Type = 1 to match your screenshot
          const vals = [
            "",                         // No.
            "1",                        // Tran Type
            String(r.line || ""),       // Line No
            csvSafe(r.item),
            csvSafe(r.lotSerial),
            csvSafe(r.exp),
            String(r.qty),
            r.cost === "" ? "" : String(r.cost),
            csvSafe(r.bin)
          ];
          lines.push(vals.join(","));
        }
        return lines.join("\r\n");
      };

      const csv = toCsv(rows);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `lot-serial-moves-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    const csvSafe = (v) => {
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    };

    // ====== WIRE UP ======
    document.getElementById("btnLoad").addEventListener("click", loadInventory);
    document.getElementById("btnAdd").addEventListener("click", addMove);
    document.getElementById("btnClear").addEventListener("click", clearAll);
    document.getElementById("btnDownload").addEventListener("click", downloadCSV);

    // Enable Enter-to-add on IMEI field
    document.getElementById("imei").addEventListener("keydown", (e) => {
      if (e.key === "Enter") addMove();
    });

    // Pre-fill CSV URL if hardcoded
    window.addEventListener("DOMContentLoaded", () => {
      if (INVENTORY_CSV_URL) {
        document.getElementById("csvUrl").value = INVENTORY_CSV_URL;
        loadInventory();
      }
    });
  </script>
</body>
</html>
